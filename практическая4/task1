#include <windows.h>
#include <clocale>
#include <fcntl.h>
#include <io.h>

#include <iostream>
#include <string>

namespace
{
    const wchar_t* kSubKey = L"Software\\CityGreetingApp";
    const wchar_t* kValueCity = L"City";
    const wchar_t* kValueColor = L"Color";

    bool WriteStringValue(HKEY root, const wchar_t* subKey, const wchar_t* valueName, const std::wstring& value)
    {
        HKEY hKey = nullptr;
        DWORD disposition = 0;

        const LONG status = RegCreateKeyExW(
            root, subKey, 0, nullptr, 0, KEY_SET_VALUE, nullptr, &hKey, &disposition);

        if (status != ERROR_SUCCESS)
        {
            return false;
        }

        const DWORD bytes = static_cast<DWORD>((value.size() + 1) * sizeof(wchar_t));
        const LONG status2 = RegSetValueExW(
            hKey, valueName, 0, REG_SZ, reinterpret_cast<const BYTE*>(value.c_str()), bytes);

        RegCloseKey(hKey);
        return status2 == ERROR_SUCCESS;
    }

    bool ReadStringValue(HKEY root, const wchar_t* subKey, const wchar_t* valueName, std::wstring& outValue)
    {
        outValue.clear();

        HKEY hKey = nullptr;
        const LONG status = RegOpenKeyExW(root, subKey, 0, KEY_QUERY_VALUE, &hKey);
        if (status != ERROR_SUCCESS)
        {
            return false;
        }

        DWORD type = 0;
        DWORD bytes = 0;
        LONG status2 = RegQueryValueExW(hKey, valueName, nullptr, &type, nullptr, &bytes);
        if (status2 != ERROR_SUCCESS || type != REG_SZ || bytes < sizeof(wchar_t))
        {
            RegCloseKey(hKey);
            return false;
        }

        std::wstring buffer(bytes / sizeof(wchar_t), L'\0');
        status2 = RegQueryValueExW(
            hKey, valueName, nullptr, nullptr, reinterpret_cast<BYTE*>(&buffer[0]), &bytes);

        RegCloseKey(hKey);

        if (status2 != ERROR_SUCCESS)
        {
            return false;
        }

        if (!buffer.empty() && buffer.back() == L'\0')
        {
            buffer.pop_back();
        }

        outValue = buffer;
        return true;
    }

    bool WriteDwordValue(HKEY root, const wchar_t* subKey, const wchar_t* valueName, DWORD value)
    {
        HKEY hKey = nullptr;
        DWORD disposition = 0;

        const LONG status = RegCreateKeyExW(
            root, subKey, 0, nullptr, 0, KEY_SET_VALUE, nullptr, &hKey, &disposition);

        if (status != ERROR_SUCCESS)
        {
            return false;
        }

        const LONG status2 = RegSetValueExW(
            hKey, valueName, 0, REG_DWORD, reinterpret_cast<const BYTE*>(&value), sizeof(value));

        RegCloseKey(hKey);
        return status2 == ERROR_SUCCESS;
    }

    bool ReadDwordValue(HKEY root, const wchar_t* subKey, const wchar_t* valueName, DWORD& outValue)
    {
        outValue = 0;

        HKEY hKey = nullptr;
        const LONG status = RegOpenKeyExW(root, subKey, 0, KEY_QUERY_VALUE, &hKey);
        if (status != ERROR_SUCCESS)
        {
            return false;
        }

        DWORD type = 0;
        DWORD value = 0;
        DWORD bytes = sizeof(value);

        const LONG status2 = RegQueryValueExW(
            hKey, valueName, nullptr, &type, reinterpret_cast<BYTE*>(&value), &bytes);

        RegCloseKey(hKey);

        if (status2 != ERROR_SUCCESS || type != REG_DWORD)
        {
            return false;
        }

        outValue = value;
        return true;
    }

    WORD GetCurrentConsoleAttributes()
    {
        HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);
        CONSOLE_SCREEN_BUFFER_INFO info{};
        if (GetConsoleScreenBufferInfo(hOut, &info))
        {
            return info.wAttributes;
        }
        return FOREGROUND_RED | FOREGROUND_GREEN | FOREGROUND_BLUE;
    }

    void PrintGreeting(const std::wstring& city, WORD foregroundColor)
    {
        HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);
        const WORD original = GetCurrentConsoleAttributes();

        const WORD background = original & 0xF0;
        const WORD fg = foregroundColor & 0x0F;

        SetConsoleTextAttribute(hOut, background | fg);
        std::wcout << L"������ ���������. ��� ������� �����: " << city << L"\n";
        SetConsoleTextAttribute(hOut, original);
    }
}  // namespace

int main()
{
    std::setlocale(LC_ALL, "Russian");

    _setmode(_fileno(stdout), _O_U16TEXT);
    _setmode(_fileno(stdin), _O_U16TEXT);

    std::wstring city;
    DWORD color = 0;

    const bool hasCity = ReadStringValue(HKEY_CURRENT_USER, kSubKey, kValueCity, city);
    const bool hasColor = ReadDwordValue(HKEY_CURRENT_USER, kSubKey, kValueColor, color);

    if (!hasCity)
    {
        std::wcout << L"������� ������� �����: ";
        std::getline(std::wcin >> std::ws, city);
        WriteStringValue(HKEY_CURRENT_USER, kSubKey, kValueCity, city);
    }

    if (!hasColor)
    {
        std::wcout << L"������� ���� ������ (0 - 15): ";
        std::wcin >> color;
        if (color > 15) color = 7; // ���������� �������� (�����)
        WriteDwordValue(HKEY_CURRENT_USER, kSubKey, kValueColor, color);
    }

    PrintGreeting(city, static_cast<WORD>(color));
    return 0;
}
